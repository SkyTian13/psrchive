/***************************************************************************
 *
 *   Copyright (C) 2003 by Willem van Straten
 *   Licensed under the Academic Free License version 2.1
 *
 ***************************************************************************/

#include "Pulsar/Integration.h"
#include "Pulsar/Profile.h"

using namespace std;

/*! This method currently produces a toa for the first polarization state,
  be it the total intensity, XX, invariant interval, etc. */
void Pulsar::Integration::toas (vector<Tempo::toa>& toas,
				const Integration& std_subint,
				const string& nsite, string arguments,
				Tempo::toa::Format fmt,
				bool discard_bad) const
{
  // empty the vector
  toas.resize (0);

  // get the standard profile
  const Profile* standard = std_subint.get_Profile (0, 0);

  // get the topocentric folding period
  double folding_period = get_folding_period();

  // get the mid time of the integration (rise time of bin 0 in each profile)
  MJD epoch = get_epoch ();

  // the time-of-arrival
  Tempo::toa toa;

  // auxilliary information
  char extra[20];

  for (unsigned ichan=0; ichan < get_nchan(); ++ichan) {

    if (std_subint.get_nchan() > 1) {
	  standard = std_subint.get_Profile (0, ichan);
	}

    const Profile* profile = get_Profile (0, ichan);

    if (discard_bad && profile->get_weight() == 0)
      continue;
    
    try {
      
      toa = profile->toa (standard, epoch, folding_period, nsite, 
			  arguments, fmt);
      
      if (get_dedispersed())
	toa.set_frequency (get_centre_frequency());
      
    }
    catch (Error& error)  {
      if (verbose)
	cerr << "Pulsar::Integration::toas error" << error << endl;
      continue;
    }
    
    if (fmt == Tempo::toa::Parkes || fmt == Tempo::toa::Psrclock) {
      sprintf(extra, "%d", ichan);
      toa.set_auxilliary_text(extra);
    }
    
    toas.push_back (toa);

  }
}

