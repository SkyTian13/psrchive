/***************************************************************************
 *
 *   Copyright (C) 2006 by Willem van Straten
 *   Licensed under the Academic Free License version 2.1
 *
 ***************************************************************************/

#define _DEBUG 1

#include "Pulsar/Config.h"

// This file is generated by configure
#include "Management/psrchive_install.h"

#include "CommandParser.h"

#include <stdlib.h>

#include <iostream>

using namespace std;

#include "debug.h"

// global configuration
Configuration* Pulsar::Config::config = 0;

//
Pulsar::Config::Interface* Pulsar::Config::interface = 0;

void Pulsar::Config::load_config () 
{
  config = new Configuration;

  const char* psrchive_config = getenv ("PSRCHIVE_CONFIG");
  if (psrchive_config) try
  {
    DEBUG("Pulsar::Config::load_config $PSRCHIVE_CONFIG=" << psrchive_config);
    config->load( psrchive_config );
  }
  catch (Error& error)
  {
    // use of a configuration file is optional
    DEBUG("Pulsar::Config::load_config error loading " << psrchive_config << " "  << error.get_message());
  }
  
  const char* home = getenv ("HOME");
  if (home) try
  {
    DEBUG("Pulsar::Config::load_config WVS 2 JV $HOME=" << home);
    string home_config = string(home) + "/.psrchive.cfg";
    config->load( home_config );
  }
  catch (Error& error)
  {
    // use of a configuration file is optional
    DEBUG("Pulsar::Config::load_config error loading " << home << "/.psrchive.cfg "  << error.get_message());
  }

  const char* psrchive_config_last = getenv ("PSRCHIVE_CONFIG_LAST");
  if (psrchive_config_last) try
  {
    DEBUG("Pulsar::Config::load_config $PSRCHIVE_CONFIG_LAST=" << psrchive_config_last);
    config->load( psrchive_config_last );
  }
  catch (Error& error)
  {
    // use of a configuration file is optional
    DEBUG("Pulsar::Config::load_config error loading " << psrchive_config_last << " "  << error.get_message());
  }
}



string Pulsar::Config::get_runtime ()
{
  return get_home() + "/share";
}

string Pulsar::Config::get_home ()
{
  char* psrchive = getenv ("PSRCHIVE");
  if (psrchive)
    return psrchive;

  return PSRCHIVE_INSTALL;
}

//! Return the configuration key/value pairs
Configuration* Pulsar::Config::get_configuration ()
{
  if (!config)
    load_config ();

  DEBUG("Pulsar::Config::get_configuration return " << config);

  return config;
}

//! Return the text interface to the configuration parameters
Pulsar::Config::Interface* Pulsar::Config::get_interface ()
{
  if (!interface)
    interface = new Interface;

  DEBUG("Pulsar::Config::get_interface return " << interface);

  return interface;
}

